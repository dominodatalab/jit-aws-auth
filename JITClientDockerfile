ARG pythonversion=3.13
FROM cgr.dev/dominodatalab.com/python:${pythonversion}-dev AS build
COPY --chown=nonroot:nonroot jit-client /app
WORKDIR /app
ENV PATH="/app/venv/bin:$PATH"
RUN python -m venv venv 
RUN pip install --no-cache-dir -r requirements.txt && rm requirements.txt
RUN mkdir /app/clientbin && chown nonroot:nonroot /app/clientbin


FROM ubuntu:24.04 as client-build
RUN apt update && apt install -y --no-install-recommends gcc libc-bin python3 python3-pip python3-dev && pip install -U --break-system-packages pyinstaller
COPY jit-client/client-src /app
WORKDIR /app
RUN pyinstaller --onefile --clean credential_helper.py && pyinstaller --onefile --clean test_jit_client.py

FROM cgr.dev/dominodatalab.com/python:${pythonversion}
ARG COMMITHASH
ARG RELEASEVER
ENV LOG_LEVEL=INFO
ENV PYTHONUNBUFFERED=true
ENV PATH="/app/venv/bin:$PATH"
ENV COMMIT=$COMMITHASH
ENV RELEASE=$RELEASEVER
COPY --from=build --chown=nonroot:nonroot /app /app
COPY --from=client-build /app/dist /app/clientbin
WORKDIR /app
ENTRYPOINT ["python", "/app/jit-client-proxy.py" ]

# FROM quay.io/domino/python-public:3.8.7-slim
# ADD requirements.txt .
# ENV PATH=$PATH:/app/.local/bin:/app/bin
# ENV PYTHONUNBUFFERED=true
# ENV PYTHONUSERBASE=/home/app
# ENV FLASK_ENV=production
# ENV LOG_LEVEL=INFO
# RUN pip install --upgrade pip
# RUN pip install --user -r requirements.txt
# RUN apt-get update && apt-get upgrade -y
# RUN mkdir /var/log/jit && chown 1000 /var/log/jit
# ADD jit-client /app
# USER 1000
# ENTRYPOINT ["python", "/app/jit-client-proxy.py" ]